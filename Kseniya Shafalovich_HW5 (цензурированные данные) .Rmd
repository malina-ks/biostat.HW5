---
title: "Untitled"
format: html
editor: visual
---

```{r}
# Загрузите набор данных по раку молочной железы, штат Висконсин.

# В колонке diagnosis содержится информация об опухоли (M = злокачественная, B = доброкачественная).

```

```{r}
#Задание 1 (2 балла) Создайте регрессионную модель, которая бы описывала связь среднего радиуса опухоли и средней площади (а), среднего периметра (б), средней симметричности (в)

# Постройте графики, на которых отразите регрессионную динамику, и прокомментируйте свои находки
```

```{r}
# Загрузка библиотеки для работы с данными
library(ggplot2)
library(tidyverse)
library(car)
library(survival)
library(ggsurvfit)
library(survminer)

# Загрузка данных Breast Cancer Wisconsin
data <- read.csv("C:\\Users\\Asus\\Downloads\\bioinfo\\HW5\\wisconsin_breast_cancer.csv")

# Просмотр структуры данных
str(data)
```

```{r}
# Проверка пропусков в указанных столбцах
missing_values <- sapply(data[, c("radius_mean", "area_mean", "perimeter_mean", "symmetry_mean", "diagnosis")], function(x) sum(is.na(x)))

# Вывод количества пропусков в каждом столбце
print(missing_values)
```

```{r}

```

```{r}
```

```{r}

```

```{r}
# Создание регрессионной модели
model <- lm(radius_mean ~ area_mean + perimeter_mean + symmetry_mean, data = data)

# Вывод информации о модели
summary(model)

```

Модель имеет очень высокое значение коэффициента детерминации (R-squared), что указывает на то, что модель хорошо подходит к данным.

Коэффициент для переменной "area_mean" значительно отличается от нуля (p-value \< 0.001), что указывает на то, что эта переменная имеет значительное влияние на значение "radius_mean"

Коэффициент для переменной "perimeter_mean" также значительно отличается от нуля (p-value \< 0.001), что указывает на то, что эта переменная также имеет значительное влияние на значение "radius_mean".

Коэффициент для переменной "symmetry_mean" также значительно отличается от нуля (p-value \< 0.001), что указывает на то, что эта переменная также имеет значительное влияние на значение "radius_mean".

Коэффициенты для всех трех переменных имеют ожидаемые знаки: увеличение значений "area_mean", "perimeter_mean" и "symmetry_mean" коррелирует с увеличением значений "radius_mean".

Остаточная стандартная ошибка (Residual standard error) составляет 0.1898, что указывает на то, что модель в целом хорошо предсказывает значения "radius_mean".

Оценки коэффициентов имеют довольно малые стандартые ошибки, что указывает на то, что оценки довольно точные.

Общая статистика F также значима (p-value \< 0.001).

```{r}
# Построение графиков
ggplot(data, aes(x=area_mean, y=radius_mean)) +
  geom_point() +
  geom_smooth(method="lm", se=FALSE, color="red") +
  labs(x="Средняя площадь", y="Средний радиус") +
  ggtitle("Регрессионная модель: Средний радиус относительно средней площади")

ggplot(data, aes(x=perimeter_mean, y=radius_mean)) +
  geom_point() +
  geom_smooth(method="lm", se=FALSE, color="blue") +
  labs(x="Средний периметр", y="Средний радиус") +
  ggtitle("Регрессионная модель: Средний радиус относительно среднего периметра")

ggplot(data, aes(x=symmetry_mean, y=radius_mean)) +
  geom_point() +
  geom_smooth(method="lm", se=FALSE, color="green") +
  labs(x="Средняя симметричность", y="Средний радиус") +
  ggtitle("Регрессионная модель: Средний радиус относительно средней симметричности")


```

На графиках мы видим, что между средним радиусом и средней симметричностью нет такой же сильной корреляции, как между средним радиусом и средней площадью или средним периметром. Это может означать, что средняя симметричность не является таким важным фактором для предсказания среднего радиуса, как средняя площадь или средний периметр. Это может быть связано с тем, что симметричность не является столь же точным показателем размера опухоли, как площадь или периметр. Кроме того, то, что точки на графике среднего радиуса и средней симметричности расположены рассеянно, может указывать на то, что есть другие факторы, которые могут влиять на средний радиус, и что эти факторы могут быть более важными, чем средняя симметричность. Это может быть связано с тем, что симметричность опухоли может быть более сложной величиной, чем площадь или периметр, и может зависеть от многих других факторов, таких как форма опухоли, расположение опухоли в груди... В любом случае, этот график указывает на то, что средняя симметричность может быть менее полезным показателем для предсказания среднего радиуса, чем средняя площадь или средний периметр, и что могут быть необходимы дополнительные исследования, чтобы понять, какие другие факторы могут влиять на средний радиус опухоли.

```{r}

```

Задание 2 (2 балла) Пусть колонка с диагнозом принимает следующие значения: злокачественная опухоль — 1, а доброкачественная — 0. Постройте модель, которая бы прогнозировала вероятность возникновения злокачественной опухоли от среднего радиуса (а), средней площади (б), средней текстуры (в).

Постройте графики. Создайте модель, которая бы прогнозировала вероятность возникновения злокачественной опухоли от всех трех перечисленных факторов.

```{r}

# Перекодирование колонки diagnosis
data$diagnosis <- ifelse(data$diagnosis == "M", 1, 0)

# Создание логистической регрессионной модели с тремя предикторами (средний радиус, средняя площадь, средняя текстура)
logistic_model <- glm(diagnosis ~ radius_mean + area_mean + texture_mean, data = data, family = binomial)

# Выводим сводку по модели
summary(logistic_model)

# Построение графика для каждого предиктора
ggplot(data, aes(x = radius_mean, y = diagnosis)) +
  geom_point() +
  geom_smooth(method = "glm", method.args = list(family = "binomial"), se = FALSE) +
  labs(x = "Средний радиус", y = "Вероятность злокачественной опухоли") +
  ggtitle("Вероятность злокачественной опухоли в зависимости от среднего радиуса")

ggplot(data, aes(x = area_mean, y = diagnosis)) +
  geom_point() +
  geom_smooth(method = "glm", method.args = list(family = "binomial"), se = FALSE) +
  labs(x = "Средняя площадь", y = "Вероятность злокачественной опухоли") +
  ggtitle("Вероятность злокачественной опухоли в зависимости от средней площади")

ggplot(data, aes(x = texture_mean, y = diagnosis)) +
  geom_point() +
  geom_smooth(method = "glm", method.args = list(family = "binomial"), se = FALSE) +
  labs(x = "Средняя текстура", y = "Вероятность злокачественной опухоли") +
  ggtitle("Вероятность злокачественной опухоли в зависимости от средней текстуры")


```

texture_mean имеет статистически значимое влияние на вероятность возникновения злокачественной опухоли, так как его коэффициент имеет низкое p-значение (1.78e-08), тогда как для других значений (radius_mean, area_mean) коэффициенты не являются статистически значимыми на уровне значимости 0.05.

Коэффициенты radius_mean и area_mean отрицательны, что указывает на то, что увеличение этих переменных снижает вероятность возникновения злокачественной опухоли, но не стоит забывать, что эти факторы не являются статистически значимыми, и мы не можем делать на основе этих значений выводы. Коэффициент texture_mean положителен, что означает, что увеличение текстуры может увеличить шанс злокачественной опухоли (этот эффект является статистически значимым).

Для оценки качества модели важно рассмотреть значения нулевого и остаточного отклонения. Значение остаточного отклонения (Residual deviance) существенно меньше значения нулевого отклонения (Null deviance), что указывает на то, что модель лучше объясняет данные, чем модель без предикторов. Однако, значение критерия информационной акаики (AIC) может быть неправильным, если модель не сошлась (о чем также свидетельствует предупреждение о количестве итераций), модель сходится после 7 итераций, что может указывать на сложности с оценкой параметров.

```{r}

```

Задание 3 (6 балла) Для выполнения этого задания вам понадобится датасет lung, который встроен в пакет survival. Установите этот пакет и загрузите датасет.

Датасет содержит следующий набор переменных:

inst: код учреждения; time: время выживаемости в днях; status: 1 = цензурирование, 2 = смерть; age: возраст в годах; sex: мужской = 1, женский = 2; ph.ecog: шкала опросника ECOG (оценку проводит врач). 0 = отсутствие симптомов, 1= симптомы есть, но пациент наблюдается амбулаторно, 2 = меньше половины дня пациент вынужден проводить в постели, 3 = больше половины дня нуждается в отдыхе лежа, но не прикован к постели, 4 = прикован к постели; ph.karno: шкала Карновского (от 0 до 100, от худшего к лучшему) по оценке врача; pat.karno: шкала Карновского (от 0 до 100, от худшего к лучшему) по оценке пациента; meal.cal: калории потребляемой пищи; wt.loss: потеря веса за последние полгода. Создайте переменную event, в которой отразите наличие или отсутствие (1 или 0) интересующего события — смерти пациента.

Изучите работу функций Surv(), survfit() и ggsurvplot():

Постройте кривые выживаемости в зависимости от пола (на одном графике должны получиться две кривые для каждого пола и таблица числа пациентов, подверженных риску (at risk) под ним). Поясните получившееся значение p-value для лог-рангового теста и опишите наблюдаемые результаты. Постройте график кумулятивной функции рисков (cumulative hazard function) для пола. Проинтерпретируйте график. С помощью функции coxph() постройте регрессию Кокса и оцените влияние пола на выживаемость. Что вы можете сказать о полученных результатах?

```{r}
# Загрузка датасета lung
lung <- survival::lung
head(lung)
```

```{r}
# Создание переменной event
lung$event <- ifelse(lung$status == 2, 1, 0)

```

```{r}
# Построение кривых выживаемости в зависимости от пола
lung_surv_fit <- survfit(Surv(time, event) ~ sex, data = lung)

# Визуализация кривых выживаемости 
ggsurvplot(lung_surv_fit, data = lung, risk.table = TRUE)


```

По графику мы наблюдаем, что выживаемость у женщин немного выше, чем у мужчин, однако после отметки 750 она выравнивается.

```{r}
# Построение кривой кумулятивной функции рисков для пола
plot(lung_surv_fit_sex, fun = "cumhaz", xlab = "Время", ylab = "Кумулятивная функция рисков", col = c("blue", "red"))
legend("topright", legend = c("Мужчины", "Женщины"), col = c("blue", "red"), lty = 1:2, cex = 0.8)


```

Из графика видно, что у мужчин уровень риска немного выше, чем у женщин, но в обеих группах наблюдается рост риска со временем.

```{r}
# Построение модели Cox
cox_model <- coxph(Surv(time, event) ~ sex, data = lung)

# Вывод результатов
summary(cox_model)

```

Модель Кокса, учитывает цензурирование, включая его в функцию вероятности, лежащую в основе анализа. Это позволяет включить всех субъектов, которые внесли свой вклад в время выживания, независимо от того, известен ли их исход, в то время как другие методы могут просто отбрасывать все их данные как пропущенные. Поэтому перед построением кривых выживаемости не всегда требуется дополнительное цензурирование.

Коэффициент для переменной пола составляет -0.5310. Это означает, что женщины (пол = 2) имеют менее высокий риск смерти по сравнению с мужчинами (пол = 1). Этот результат является статистически значимым на уровне значимости 0.05 (p = 0.00149).\
Экспонента коэффициента (exp(coef)) для пола равна 0.588. Это означает, что отношение риска смерти для мужчин к женщинам составляет 0.588, это означает, что женщины имеют примерно на 41.2% меньший риск смерти, чем мужчины.

Доверительный интервал для коэффициента пола (sex) составляет от 0.4237 до 0.816. Это означает, что мы с уверенностью 95% можем сказать, что отношение риска смерти для мужчин к женщинам лежит в этом интервале.

Значение Concordance (0.579) указывает на то, что модель имеет умеренную прогностическую способность. Значения тестов сравнения модели (Likelihood ratio test, Wald test, Score (logrank) test) также показывают статистически значимые результаты (p \< 0.05), что подтверждает значимость влияния пола на выживаемость.

Исходя из полученных данных можно сделать выводы, что пол пациента оказывает значительное влияние на риск смерти (женщины имеют более низкий риск смерти по сравнению с мужчинами).

Чтобы увидеть разницу, построим графики с цензурированными данными

```{r}

# Подготовка данных
lung_filtered <- lung[lung$status == 2, ]

# Вычисление выживаемости по полу
fit <- survfit(Surv(time, event) ~ sex, data = lung_filtered)

# Выполнение лог-рангового теста
logrank_test <- survdiff(Surv(time, event) ~ sex, data = lung_filtered)

# Вывод результатов
print(logrank_test)


```

```{r}
# Визуализация
ggsurvplot(fit, data = lung_filtered, risk.table = TRUE, pval = TRUE)

```

```{r}

#  Статистика теста равна 2.2 с 1 степенью свободы, а значение p равно 0.1. Это означает, что нет достаточных доказательств для отклонения нулевой гипотезы о том, что нет различий в выживаемости между двумя группами.


```

```{r}

# Построение графика кумулятивных функций рисков
plot(fit, fun = "cumhaz", xlab = "Время", ylab = "Кумулятивная функция рисков", col = c("blue", "red"))
legend("topright", legend = c("Мужчины", "Женщины"), col = c("blue", "red"), lty = 1:2, cex = 0.8)


```

Данные немного отличаются, наблюдаем с увеличением времени пересечение кривых

```{r}
# Вычисление модели Cox
cox_model <- coxph(Surv(time, event) ~ sex, data = lung_filtered)

# Вывод результатов
summary(cox_model)
```

Среди умерших данная модель показала такие результаты:

Коэффициент для переменной пола (sex) составляет -0.2511. Это означает, что у женщин (пол = 2) наблюдается снижение риска смерти по сравнению с мужчинами (пол = 1)

Экспонента коэффициента (exp(coef)) для переменной пола равна 0.7779. Это означает, что у женщин риск смерти на 22.21% ниже, чем у мужчин.

Значение p-value для переменной пола равно 0.136, что означает, что различия в выживаемости между мужчинами и женщинами не являются статистически значимыми на уровне значимости 0.05.\
Значение конкордации (Concordance) равно 0.543, что указывает на среднюю прогностическую способность модели.\
Тест отношения правдоподобия (Likelihood ratio test), тест Уолда (Wald test) и тест лог-ранга (Score test) не показывают статистически значимых различий в выживаемости между мужчинами и женщинами, так как значения p-value для всех тестов составляют 0.1.\
Таким образом, на основе результатов модели Cox можно сделать вывод, что пол не оказывает статистически значимого влияния на выживаемость среди умерших пациентов в данном наборе данных.\
\

\
